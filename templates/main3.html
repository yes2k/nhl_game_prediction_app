<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Game Prediction App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">NHL Game Prediction App</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="nav nav-pills" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link">Game Prediction</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Team Parameters</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Season Projection</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid", id="game_prediction">
        <div class="row">
            <div class="col-md-2">
                <div class="sidebar">
                    <h5>Select Date</h5>
                    <input type="date" class="form-control mb-3">
                    <h5>Select Game</h5>
                    <select class="form-control"></select>
                    <button type="button" class="btn btn-primary mt-3" id="predict_game">Predict</button>
                </div>
            </div>
            <div class="col-md-9">
                <!-- Main content goes here -->
                 <div id = "heatmap_plot"></div>
            </div>
        </div>
    </div>

    <div class="container-fluid" id="team_params" style="display: none;"></div>
    <div class="container-fluid" id="season_projection" style="display: none;"></div>

    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.js"></script>

    <script>
        // Update select game options
        document.querySelector('input[type="date"]').addEventListener('change', function() {
            const date = this.value;
            fetch(`/game_ids/${date}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.querySelector('select');
                    select.innerHTML = '';
                    data.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.id;
                        option.textContent = `${game.away_team} @ ${game.home_team}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching game IDs:', error));
        });

        // Predict button click event
        document.getElementById('predict_game').addEventListener('click', function() {
            const date = document.querySelector('input[type="date"]').value;

            // TODO get the right thing
            // const gameText = document.querySelector('select').textContent;
            const gameText = document.querySelector('select').selectedOptions[0].textContent;

            const [away_team, home_team] = gameText.split(' @ ');
            console.log(date, home_team, away_team);
            fetch(`/game/${date}?home_team=${home_team}&away_team=${away_team}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    create_heatmap(data.table_of_pred, 'heatmap_plot', home_team, away_team, data.home_team_win_prob);
                })
                .catch(error => console.error('Error fetching prediction:', error));
        });

        // Navbar link click event
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.container-fluid').forEach(div => {
                    div.style.display = 'none';
                });
                if (this.textContent === 'Game Prediction') {
                    document.getElementById('game_prediction').style.display = 'block';
                } else if (this.textContent === 'Team Parameters') {
                    document.getElementById('team_params').style.display = 'block';
                } else if (this.textContent === 'Season Projection') {
                    document.getElementById('season_projection').style.display = 'block';
                }
            });
        });
    </script>


    <!-- Helper Functions -->   
     <script>
        function create_heatmap(df, id, home_team_name, away_team_name, win_prob){

            d3.select(`#${id}`).select("svg").remove();

            const margin = { top: 100, right: 50, bottom: 50, left: 50 };
            const width = 500 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select(`#${id}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(df.map(d => d.home))
                .padding(0.01);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            const y = d3.scaleBand()
                .range([height, 0])
                .domain(df.map(d => d.away))
                .padding(0.01);

            svg.append("g")
                .call(d3.axisLeft(y));

            const colorScale = d3.scaleLinear()
                .range(["white", "#69b3a2"])
                .domain([0, d3.max(df, d => d.len)]);

            // X-axis label
            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.top - 50})`)
                .style("text-anchor", "middle")
                .text(`${home_team_name} Goals`);

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(`${away_team_name} Goals`);
            
            svg.append("text")
                .attr("x", 0)
                .attr("y", -50)
                .attr("text-anchor", "left")
                .style("font-size", "22px")
                .html(`${home_team_name} vs ${away_team_name} Goal Heatmap`);

            // Add subtitle to graph
            svg.append("text")
                .attr("x", 0)
                .attr("y", -20)
                .attr("text-anchor", "left")
                .style("font-size", "14px")
                .style("fill", "grey")
                .style("max-width", 400)
                .html(`${home_team_name} Win Probability: ${win_prob}%`);

            
                
            // Three function that change the tooltip when user hover / move / leave a cell
            const tooltip = d3.select(`#${id}`)
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px")
                    
            const mouseover = function(event,d) {
                tooltip.style("opacity", 1)
            }
            const mousemove = function(event,d) {
                tooltip
                    .html(`${home_team_name} goals : ${event.home}<br>${away_team_name} goals : ${event.away}<br>Probability : ${event.len.toFixed(2)}%`)
                    .style("left", (d3.mouse(this)[0]+70) + "px")
                    .style("top", (d3.mouse(this)[1]) + "px")
            }
            const mouseleave = function(d) {
                tooltip.style("opacity", 0)
            }
                        
            
            svg.selectAll()
                .data(df, d => d.home + ':' + d.away)
                .enter()
                .append("rect")
                .attr("x", d => x(d.home))
                .attr("y", d => y(d.away))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", d => colorScale(d.len))
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave);
        }

        function create_scatterplot(df, id){
            d3.select(`#${id}`).select("svg").remove();

            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const width = 500 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select(`#${id}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(df, d => d.x)])
                .range([0, width]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            const y = d3.scaleLinear()
                .domain([0, d3.max(df, d => d.y)])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.top - 10})`)
                .style("text-anchor", "middle")
                .text("X Axis Label");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Y Axis Label");

            svg.selectAll("dot")
                .data(df)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.x))
                .attr("cy", d => y(d.y))
                .attr("r", 5)
                .style("fill", "#69b3a2");
        }
    </script>
</body>
</html>